@using Microsoft.Extensions.DependencyInjection
@using Microsoft.Extensions.Options
@using StudySauce.Shared.Services
@inherits LayoutComponentBase
@implements IDisposable

@inject IJSRuntime JS
@inject IMenuService MenuService
@inject IStudyService StudyService
@inject ITitleService TitleService
@inject IServiceProvider ServiceProvider
@inject IJsonService JsonService
@inject NavigationManager Nav

<div class="@(Study == true ? "study-mode" : "") @PageClass page">
    <div class="canvas-container">
        <canvas id="lichtenbergCanvas"></canvas>
    </div>
    <div class="sidebar">
        <NavMenu />
    </div>

    @foreach (var item in State)
    {
        <input type="hidden" name="state_@item.Key" value="@item.Value" />
    }

    <main>
        @if (ShowHeader != false)
        {
            <header class="top-row px-4">
                @if (HeaderTitle != null)
                {
                    <h2>@HeaderTitle</h2>            
                }
                @* This is where the contextual menu will appear *@
                @if (HeaderMenu != null)
                {
                    <div class="contextual-menu">
                        @HeaderMenu
                    </div>
                }
                @if (HeaderMenu == null && HeaderTitle == null)
                {
                    <span>&nbsp;</span>
                }
                <NavLink class="header-link" href="@(NavigationExtensions.GetUri<Pages.Landing.About>())" Match="NavLinkMatch.All">
                    <i class="bi bi-info-circle" aria-hidden="true"></i>
                    <span class="header-text">About</span>
                </NavLink>

            </header>
        }

        <article class="content px-4">
            @* We pass the Layout instance to the Body so pages can set the HeaderMenu *@
            @Body
        </article>


    @* Connected to @server.BaseUrl *@
    </main>

</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    public RenderFragment? HeaderMenu { get; private set; }
    public string? HeaderTitle { get; private set; }
    //public object? Tag { get; set; } // for comparing states for implementers
    public bool? Study { get; set; }
    public string? PageClass { get; set; }
    public bool? ShowHeader { get; set; }

    /*
     * This is so fucking dumb this isn't more obvious like Nav.GetComponent(route);
     * what the fuck is Microsoft thinking?
    public Type? GetPageTypeFromUrl(string url)
    {
        // 1. Get the relative path
        var relativeUri = Nav.ToBaseRelativePath(url);

        // 2. Access the Route Options / Discovery service
        // This is the same engine the Router uses
        var routeOptions = ServiceProvider.GetRequiredService<IOptions<RazorPagesOptions>>();

        // Note: In pure WASM, you usually have to reflect into the
        // assembly to find the [Route] attributes yourself if you want
        // to bypass the Router component entirely.
        return typeof(Program).Assembly.GetTypes()
        .FirstOrDefault(t => t.GetCustomAttributes<RouteAttribute>()
        .Any(r => r.Template.Equals("/" + relativeUri, StringComparison.OrdinalIgnoreCase)));
        }
    */

    protected void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        SetPageClass();
    }

    private void SetPageClass()
    {
        var relativePath = Nav.ToBaseRelativePath(Nav.Uri);
        PageClass = string.IsNullOrWhiteSpace(relativePath) ? "home" : relativePath.ToSafe();
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        // Subscribe to the push event
        Nav.LocationChanged += OnLocationChanged;
        TitleService.OnTitleChanged += SetTitle;
        MenuService.OnMenuChanged += SetHeaderMenu;
        MenuService.OnHeaderChanged += SetHeader;
        StudyService.OnStudyChanged += SetStudyMode;
        JsonService.OnStateChanged += SetState;
        SetPageClass();
    }

    public Dictionary<string, string?> State { get; set; } = new();

    public void SetState(IComponent? state)
    {
        if(state == null)
        {
            return;
        }
        State[state.GetType().Name.ToSafe()] = StudySauce.Shared.Utilities.Extensions.JsonExtensions.ToSerialized(state);
        this.StateHasChanged();
    }

    public void SetStudyMode(bool study)
    {
        if (Study != study)
        {
            Study = study;
            this.StateHasChanged();
        }
    }

    private void SetHeader(bool? show)
    {
        if (show != ShowHeader)
        {
            ShowHeader = show;
            this.StateHasChanged();
        }
    }

    private void SetHeaderMenu(RenderFragment? menu)
    {
        if (menu != HeaderMenu)
        {
            if (menu != null)
            {
                MenuService.SetHeader(true);
            }
            HeaderMenu = menu;
            this.StateHasChanged(); 
        }
    }

    private void SetTitle(string? title)
    {
        if (HeaderTitle != title)
        {
            //if(title != null)
            //{
            //    MenuService.SetHeader(true);
            //}
            HeaderTitle = title;
            this.StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        // This runs every time the @Body content changes
        //MenuService.SetMenu(null);
        //TitleService.UpdateTitle(null);
        //Tag = null;
        //this.StateHasChanged();
        //SetPageClass();
    }

    public void Dispose()
    {
        // Unsubscribe to prevent memory leaks
        Nav.LocationChanged -= OnLocationChanged;
        TitleService.OnTitleChanged -= SetTitle;
        MenuService.OnMenuChanged -= SetHeaderMenu;
        StudyService.OnStudyChanged -= SetStudyMode;
        MenuService.OnHeaderChanged -= SetHeader;
        JsonService.OnStateChanged -= SetState;
    }

    /*
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Assuming your SectionOutlet renders something with ID 'sync-target'
            var content = await JSRuntime.InvokeAsync<string>("eval", "document.title");
            // Now you have it in C#
        }
    }
   */
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Trigger the JS engine
            //await JS.InvokeVoidAsync("initLichtenberg", "lichtenbergCanvas");
            var _module = await JS.InvokeAsync<IJSObjectReference>("import", "/_content/StudySauce.Shared/lichtenberg.js");

            // 2. Call the function from the module
            await _module.InvokeVoidAsync("initLichtenberg", "lichtenbergCanvas");
        }
    }
}