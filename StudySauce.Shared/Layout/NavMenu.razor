@using StudySauce.Shared.Services
@inject NavigationManager Nav
@inject IStudyService StudyService

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-logo">
        <img width="48" height="48" @onclick="() => ToggleStudy()" src="_content/StudySauce.Shared/logo_4_trans_2.png" alt="LOGO" />
        <a class="navbar-brand" href="">Study Sauce</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <div class="nav-item px-3">
        <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
            <span class="bi bi-house-door-fill" aria-hidden="true"></span> Home
        </NavLink>
    </div>

    @* <div class="nav-item px-3">
        <NavLink class="nav-link" href="counter">
            <span class="bi bi-plus-square-fill-nav-menu" aria-hidden="true"></span> Counter
        </NavLink>
    </div>

    <div class="nav-item px-3">
        <NavLink class="nav-link" href="weather">
            <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span> Weather
        </NavLink>
    </div> *@

    @foreach (var item in GetVisibleItems())
    {
        @RenderNavItem(item)
    }
</div>

@code {
    public bool _studyMode = false;

    private void HandleClick(INavMenuItem item)
    {
        var currentUrl = Nav.ToBaseRelativePath(Nav.Uri);
        bool isOnTargetPage = string.Equals(currentUrl, item.Href.Trim('/'), StringComparison.InvariantCultureIgnoreCase);

        if(item.Children.Count() == 0 || _studyMode)
        {
            Nav.NavigateTo(item.Href);
        }
        else if (!item.IsCollapsed)
        {
            if (isOnTargetPage)
            {
                // Rule: Only collapse if they are already on that page
                item.IsCollapsed = true;
            }
            else
            {
                // Rule: Only connect to href if it is already expanded
                Nav.NavigateTo(item.Href);
            }
        }
        else
        {
            // If it's currently collapsed, just expand it
            item.IsCollapsed = false;
        }
    }

    protected void ToggleStudy()
    {
        StudyService?.SetStudyMode(_studyMode = !StudyService.Study);
    }

    RenderFragment RenderNavItem(INavMenuItem item) => __builder =>
    {
        var hasChildren = item.Children != null && item.Children.Any();

        <div class="nav-item px-3">
            @* Use @onclick:stopPropagation if you don't want the side-panel click logic to fire *@
            <div @onclick="() => HandleClick(item)"
                 @onclick:stopPropagation="true"
                 data-href="@item.Href">

                <NavLink class="nav-link"
                         Match="@(string.IsNullOrWhiteSpace(item.Href) ? NavLinkMatch.All : NavLinkMatch.Prefix)">

                    <span class="bi @item.Icon" aria-hidden="true"></span>
                    <span class="nav-text">@item.Title</span>

                    @if (hasChildren)
                    {
                        <span class="bi @(item.IsCollapsed ? "bi-chevron-right" : "bi-chevron-down") ms-auto small"></span>
                    }
                </NavLink>
            </div>

            @if (hasChildren && !item.IsCollapsed)
            {
                <div class="nav-children">
                    @foreach (var child in item.Children!)
                    {
                        @RenderNavItem(child)
                    }
                </div>
            }
        </div>
    };

    // This is your Iterator/List
    public static IEnumerable<INavMenuItem> MenuStructure = 
    [
        new NavMenuItem<Pages.Landing.Packs>() { Title = "Packs", Icon = "bi-card-list" },
        new NavMenuItem<Pages.Landing.Courses>() { Title = "Courses", Icon = "bi-mortarboard" },
        new NavMenuItem<Pages.Landing.Store>() { Title = "Store", Icon = "bi-cart" },
        new NavMenuItem<Pages.Landing.Results>() { Title = "Results", Icon = "bi-clipboard-data" },
        new NavMenuItem<Pages.Landing.Account>() { Title = "Account settings", Icon = "bi-person-gear" },

        // administration
        new NavMenuItem<Pages.Admin.Landing>() { Title = "Administration", Icon = "bi-shield-lock", Children = [
            new NavMenuItem<Pages.Admin.Users>() { Title = "Users", Icon = "bi-people-fill" },
            new NavMenuItem<Pages.Admin.Groups>() { Title = "Groups", Icon = "bi-collection" },
            new NavMenuItem<Pages.Admin.Import>() { Title = "User Import", Icon = "bi-file-earmark-arrow-up" },
            new NavMenuItem<Pages.Admin.Emails>() { Title = "Emails", Icon = "bi-envelope-paper" },
            new NavMenuItem<Pages.Admin.Activity>() { Title = "Recent Activity", Icon = "bi-activity" },
            new NavMenuItem<Pages.Admin.Hosting>() { Title = "Hosting", Icon = "bi-hdd-network" },
            new NavMenuItem<Pages.Admin.Status>() { Title = "Status", Icon = "bi-exclamation-triangle" },
            new NavMenuItem<Pages.Admin.Settings>() { Title = "Settings", Icon = "bi-gear" },
            // TODO: debug build only
            new NavMenuItem<Pages.Admin.Validation>() { Title = "Validation", Icon = "bi-check-circle" }
        ] },


        // going to add management stuff here
        new NavMenuItem<Pages.Content.Landing>() { Title = "Content", Icon = "bi-database-gear", Children = [
            new NavMenuItem<Pages.Content.Analytics>() { Title = "Analytics", Icon = "bi-graph-up-arrow" },
            new NavMenuItem<Pages.Content.Upload>() { Title = "Pack Import", Icon = "bi-cloud-arrow-up" },
            new NavMenuItem<Pages.Content.Analysis>() { Title = "Content Analysis", Icon = "bi-search-heart" },
            new NavMenuItem<Pages.Content.Backups>() { Title = "Backups", Icon = "bi-device-hdd" },
            new NavMenuItem<Pages.Content.Billing>() { Title = "Billing", Icon = "bi-receipt" },
            new NavMenuItem<Pages.Content.Payments>() { Title = "Payments", Icon = "bi-credit-card" },
            new NavMenuItem<Pages.Content.Merchant>() { Title = "Merchant Tools", Icon = "bi-shop" },
            new NavMenuItem<Pages.Content.Recovery>() { Title = "Recovery", Icon = "bi-life-preserver" },
            new NavMenuItem<Pages.Content.Encryption>() { Title = "Encryption", Icon = "bi-incognito" },
            new NavMenuItem<Pages.Content.Marshal>() { Title = "Marshalling", Icon = "bi-database-lock" },
            new NavMenuItem<Pages.Content.Tokens>() { Title = "Download Tokens", Icon = "bi-coin" },
            new NavMenuItem<Pages.Content.Install>() { Title = "Install AI", Icon = "bi-robot" },
            new NavMenuItem<Pages.Content.Export>() { Title = "Export", Icon = "bi-file-earmark-arrow-down" },
            new NavMenuItem<Pages.Content.Trash>() { Title = "Trash", Icon = "bi-trash3" }
        ] },

        // course tools
        new NavMenuItem<Pages.Tools.Landing>() { Title = "Study Tools", Icon = "bi-briefcase", Children = [
            new NavMenuItem<Pages.Tools.Goals>() { Title = "Goals", Icon = "bi-flag" },
            new NavMenuItem<Pages.Tools.Schedule>() { Title = "Class schedule", Icon = "bi-calendar3" },
            new NavMenuItem<Pages.Tools.Deadlines>() { Title = "Deadlines", Icon = "bi-alarm" },
            new NavMenuItem<Pages.Tools.Checkin>() { Title = "Check in", Icon = "bi-geo-alt" },
            new NavMenuItem<Pages.Tools.Metrics>() { Title = "Study metrics", Icon = "bi-bar-chart" },
            new NavMenuItem<Pages.Tools.Partners>() { Title = "Accountability", Icon = "bi-people" },
            new NavMenuItem<Pages.Tools.Calculator>() { Title = "Grade calculator", Icon = "bi-calculator" },
            new NavMenuItem<Pages.Tools.Notes>() { Title = "Notes", Icon = "bi-journal-text" },
            new NavMenuItem<Pages.Tools.Premium>() { Title = "Premium", RoleRequired = "ROLE_FREE", Icon = "bi-star-fill" }
        ] },

        .. CourseMenu.MenuStructure.OfType<INavMenuItem>(),

        new NavMenuItem<Pages.Landing.Terms>() { Title = "Terms of Service", Icon = "bi-file-earmark-text" },

    ];

    private IEnumerable<INavMenuItem> GetVisibleItems()
    {
        // Filter out items the user shouldn't see
        // For example: hide Premium link if they already paid
        return MenuStructure.Where(i => string.IsNullOrEmpty(i.RoleRequired) || !UserHasPaid);
    }

    private bool UserHasPaid => true; // Logic to check user role
}
