@implements IDisposable

@page "/course"
@page "/course/{Level:int}"
@page "/course/{Level:int}/{Lesson}"
@page "/course/{Level:int}/{Lesson}/Intro"
@page "/course/{Level:int}/{Lesson}/Video"
@page "/course/{Level:int}/{Lesson}/Quiz"
@page "/course/{Level:int}/{Lesson}/Reward"

@using StudySauce.Shared.Controls
@using Microsoft.EntityFrameworkCore
@using StudySauce.Shared.Services

@inject NavigationManager Nav
@inject TranslationContext Context
@inject ITitleService TitleService
@inject IMenuService MenuService
@inject ICourseService CourseService


@code
{

    private PackControl.ViewPack? CurrentQuiz;
    private IEnumerable<PropertyMetadata>? PackLayout;
    private List<DataLayer.Entities.Response> Responses = new();

}

<div class="course-container">
@if (ActiveItem != null)
    {
        <div class="card-viewer">

            <div class="card-stage">
                @switch (Step)
                {
                    case StepMode.Intro:
                        // TODO: change this to load dynamically from menu when i get bored of updating it
                        <div class="flash-card animate-in">
                            @if (ActiveItem.Course == typeof(Course1))
                            {
                                <Course1 Lesson="@ActiveItem.Lesson" />
                            }
                            else if (ActiveItem.Course == typeof(Course2))
                            {
                                <Course2 Lesson="@ActiveItem.Lesson" />
                            }
                            else if (ActiveItem.Course == typeof(Course3))
                            {
                                <Course3 Lesson="@ActiveItem.Lesson" />
                            }
                            <button @onclick="() => Next(StepMode.Video)">Start Lesson</button>
                        </div>
                        break;
                    case StepMode.Video:
                        <div class="flash-card animate-in">
                            <div class="video-placeholder">Video content for @Lesson</div>
                            <button @onclick="() => Next(StepMode.Quiz)">Take Quiz</button>
                        </div>
                        break;
                    case StepMode.Quiz:
                        <div class="flash-card animate-in">
                            <MetadataControl TModel="PackControl.ViewPack" Model="@PackLayout" Data="@([CurrentQuiz])"></MetadataControl>
                            @if (Responses.Count() == CardCount)
                            {
                                <button @onclick="() => Next(StepMode.Reward)">See Reward</button>
                            }
                        </div>
                        break;
                    case StepMode.Reward:
                        <div class="flash-card animate-in">
                            <div class="badge">üèÜ</div>
                            <h3>You earned 10 Trivial Bux!</h3>
                            <button @onclick="() => Next(StepMode.Investment)">Invest Tokens</button>
                        </div>
                        break;
                    case StepMode.Investment:
                        <div class="flash-card animate-in">
                            <h3>Buddy Backup Investment</h3>
                            <p>Allocate your tokens to secure your study vault.</p>
                            <button @onclick="Finish">Complete Lesson</button>
                        </div>
                        break;
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int? Level { get; set; }
    [Parameter] public string? Lesson { get; set; }
    public StepMode Step { get; set; } = StepMode.Intro;
    public int CardCount { get; set; } = 0;

    public ICourseMenuItem? ActiveItem { get; set; }
    public enum StepMode { Intro, Video, Quiz, Reward, Investment }

    protected override void OnInitialized()
    {
        PackLayout = Controls.PackControl.ViewPack.Metadata.Groups["Display"]?.ToList();
        // TODO: make sure this goes through RemoteQuery on web assembly client
        //_ = LoadDataAsync();
        Nav.LocationChanged += OnLocationChanged;
        CourseService.OnStepChanged += OnStepChanged;
        CourseService.OnCourseChanged += OnCourseChanged;
        OnSetCourseParameters();
        Console.WriteLine("Course initialized");
    }

    /*
    private async Task LoadDataAsync()
    {
        try
        {
            // If this fails, the catch block handles it gracefully
            // instead of blowing up the RenderTreeBuilder
            //CardCount = await CurrentQuiz.Cards.CountAsync<int>();
            var result = await Context.Packs.CountAsync();
            Console.WriteLine("Pack count: " + result);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"RemoteQuery failed: {ex.Message}");
            // Set a default value or error state so the UI stays stable
        }
    }*/

    protected void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        OnSetCourseParameters();
    }

    protected void OnSetCourseParameters()
    {
        var newItem = CourseMenu.GetActiveItem(Level, Lesson);

        if (ActiveItem?.Course != newItem?.Course)
        {
            CourseService.SetCourse(newItem);
        }


        var relativePath = Nav.ToBaseRelativePath(Nav.Uri);

        var segments = relativePath.Split('/');

        StepMode? newStep = null;
        if (segments.Count() >= 4)
        {
            newStep = segments[3].TryParse<StepMode>() ?? StepMode.Intro;
            if (newStep != Step)
            {
                CourseService.SetStep(newStep ?? StepMode.Intro);
            }
        }
    }

    protected void OnStepChanged(Course.StepMode? step)
    {
        Step = step ?? StepMode.Intro;
        SetCourseTitle();
        StateHasChanged();
    }

    protected void OnCourseChanged(ICourseMenuItem? item)
    {
        ActiveItem = item;
        SetCourseTitle();
        StateHasChanged();
    }

    protected void SetCourseTitle()
    {
        TitleService.UpdateTitle(ActiveItem?.Title + " - " + Step.ToString());
        //Layout?.SetHeaderTitle(builder => builder.AddContent(0, ActiveItem?.Title + " - " + Step.ToString()));

        MenuService.SetMenu(@<StudySauce.Shared.Pages.Shared.Course Step="@((int)Step)" Level="@Level" Lesson="@Lesson" />);
    
        if (ActiveItem?.Lesson != null)
        {
            //CurrentQuiz = new PackControl.ViewPack { Pack = Context.Packs.Where(p => p.Title == ActiveItem.Lesson.Name).FirstOrDefault() };
        }

    }
    
    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
        CourseService.OnStepChanged -= OnStepChanged;
        CourseService.OnCourseChanged -= OnCourseChanged;
    }

    private void Next(StepMode nextStep) => Nav.NavigateTo<Pages.Course.Course>(c => new() { Level = ActiveItem != null ? ActiveItem.Level : 1, Lesson = ActiveItem != null && ActiveItem.Lesson != null ? ActiveItem.Lesson.Name.ToSafe() : "", Step = nextStep });

    private void Finish() { /* Navigate back or to next lesson */ }
}