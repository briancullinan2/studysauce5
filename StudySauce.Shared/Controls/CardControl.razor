@using System.Timers
@code
{
    [Parameter] public Controls.CardsControl.ViewCard? Data { get; set; }
    [Parameter] public PropertyMetadata? Model { get; set; }
    [Parameter] public EventCallback<object> ValueChanged { get; set; }
    public DataLayer.Customization.ControlMode Mode
    {
        get
        {
            return Model?.DeclaringType == typeof(CardsControl.EditCard) ? DataLayer.Customization.ControlMode.Edit : DataLayer.Customization.ControlMode.View;
        }
    }
    private IEnumerable<PropertyMetadata>? AnswerLayout;
    private IEnumerable<PropertyMetadata>? CardLayout;
    protected override void OnInitialized()
    {
        AnswerLayout = CardsControl.ViewCard.Metadata.Categories["Answers"]?.ToList();
        // TODO: AnswerLayout
    }

}

This is a card
@if (Mode == DataLayer.Customization.ControlMode.Edit)
{
    <span>Editing</span>
    <MetadataControl TModel="PropertyMetadata" Model="@CardLayout"></MetadataControl>

}
else
{
    <span>Viewing</span>
}


<div class="card-front">
    <div class="preview-inner">
        @if (Data?.Card?.ContentType == DataLayer.Customization.DisplayType.Image)
        {
            <img src="@Data?.Card?.Content" class="centerized" />
        }
        else if (Data?.Card?.ContentType == DataLayer.Customization.DisplayType.Audio)
        {
            <audio controls src="@Data?.Card?.Content"></audio>
        }
        else if(Data != null && Data.Card != null)
        {
            <div class="preview-content">@((MarkupString)Data.Card.Content.Replace("\n", "<br/>"))</div>
        }
    </div>

    <div class="preview-footer">
        @if (Data?.Card?.ResponseType == null || Data?.Card?.ResponseType == DataLayer.Customization.CardType.FlashCard) // Flashcard mode
        {
            <button class="preview-tap" @onclick="Flip">Click to see answer</button>
        }
        else if (Data?.Card?.ResponseType == DataLayer.Customization.CardType.TrueFalse) // True/False
        {
            <button @onclick="@(() => HandleAnswer("false"))" class="preview-false">False</button>
            <button @onclick="@(() => HandleAnswer("true"))" class="preview-true">True</button>
        }
        else if (Data?.Card?.ResponseType == DataLayer.Customization.CardType.Multiple) // Multiple Choice
        {
            <MetadataControl TModel="PropertyMetadata" Model="@AnswerLayout"></MetadataControl>
        }
    </div>
    <div class="preview-count">@CurrentIndex of @TotalCards</div>
</div>

<div class="card-back">
    <div class="preview-prompt">
        @if (Data?.Card?.ContentType == DataLayer.Customization.DisplayType.Image)
        {
            <img src="@Data?.Card?.ResponseContent" class="centerized" />
        }
        else if (Data?.Card?.ContentType == DataLayer.Customization.DisplayType.Audio)
        {
            <audio controls src="@Data?.Card?.ResponseContent"></audio>
        }
        else if (Data != null && Data.Card != null && Data.Card.ResponseContent != null)
        {
            <div class="preview-content">@((MarkupString)Data.Card.ResponseContent.Replace("\n", "<br/>"))</div>
        }
    </div>
    <div class="preview-inner">
        <div class="preview-correct">Correct answer:</div>
        <div class="preview-content">@Data?.Card?.Answers.FirstOrDefault(a => a.IsCorrect)?.Content</div>
    </div>
    <div class="preview-footer">
        <button class="preview-wrong" @onclick="() => Next(false)">✘</button>
        <div class="preview-guess">Did you get it right?</div>
        <button class="preview-right" @onclick="() => Next(true)">✔</button>
    </div>
</div>

@*
<div class="card-container @(isFlipped ? "flipped" : "") @flashClass">
    <div class="card-inner">
        
    </div>
</div>
*@

@code {
    [Parameter] public int CurrentIndex { get; set; }
    [Parameter] public int TotalCards { get; set; }
    [Parameter] public EventCallback<bool> OnAnswered { get; set; }

    private bool isFlipped = false;
    private string flashClass = "";

    private void Flip() => isFlipped = true;

    private async Task HandleAnswer(string selectedValue)
    {
        //bool isCorrect = selectedValue.Equals(Card.CorrectAnswerValue, StringComparison.OrdinalIgnoreCase);

        // Trigger Flash Effect
        //flashClass = isCorrect ? "flash-green" : "flash-red";
        //StateHasChanged();

        //await Task.Delay(600); // Let the flash play
        //isFlipped = true;
        //flashClass = "";
    }

    private async Task Next(bool wasCorrect)
    {
        isFlipped = false;
        await OnAnswered.InvokeAsync(wasCorrect);
    }
}