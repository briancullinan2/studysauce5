@using System.Reflection
@typeparam TModel

<div class="auto-form-container">
    @if (_parameterCache != null)
    {
        @foreach (var entry in _parameterCache)
        {
            <div class="form-field">
                @*<label>@entry.Metadata.PropertyType</label>
                <label>@GetControl(entry.Metadata.PropertyType).Name</label>*@
                @{
                    var controlType = GetControl(entry.Metadata.PropertyType);
                    RenderFragment renderControl = builder =>
                    {
                        builder.OpenComponent(0, controlType);
                        // Manually assign parameters from your dictionary
                        builder.AddAttribute(1, "Model", entry.Metadata);
                        builder.AddAttribute(2, "ValueChanged", entry.Params["ValueChanged"]);
                        builder.CloseComponent();
                    };
                }
                @renderControl
                @*<DynamicComponent Type="@ControlMapper.GetControl(entry.Metadata.PropertyType)"
                                  Parameters="@entry.Params" />*@
            </div>
        }
    }
</div>

@code {
    [Parameter] public IEnumerable<PropertyMetadata>? Model { get; set; }
    [Parameter] public IEnumerable<TModel>? Data { get; set; }

    private List<(PropertyMetadata Metadata, Dictionary<string, object?> Params)>? _parameterCache;

    public static readonly Dictionary<Type, Type> TypeToControl = new()
        {
            // order matters, put more specific types first, then general system types last
            { typeof(StudySauce.Shared.Controls.PackControl.ViewPack), typeof(PackControl) },
            { typeof(StudySauce.Shared.Controls.CardsControl.ViewCard), typeof(CardControl) },
            { typeof(StudySauce.Shared.Controls.PackControl.EditPack), typeof(PackControl) },
            { typeof(StudySauce.Shared.Controls.CardsControl.EditCard), typeof(CardControl) },
            { typeof(IEnumerable<StudySauce.Shared.Controls.CardsControl.EditCard>), typeof(CardsControl) },
            { typeof(IEnumerable<StudySauce.Shared.Controls.CardsControl.ViewCard>), typeof(CardsControl) },
            //{ typeof(DateTime), typeof(DateControl) },
            //{ typeof(int), typeof(NumberControl) }
            { typeof(string), typeof(StringControl) },
            { typeof(object), typeof(TypeControl) },
        };

    public static Type GetControl(Type modelPropertyType)
    {
        foreach(var kvp in TypeToControl)
        {
            if(kvp.Key.IsAssignableFrom(modelPropertyType))
            {
                return kvp.Value;
            }
        }
        return typeof(TypeControl);
    }
    

    protected override void OnParametersSet()
    {
        // Only rebuild if the model actually exists and we haven't cached it yet
        if (Model is IEnumerable<PropertyMetadata> metadataList && _parameterCache == null)
        {
            _parameterCache = metadataList.Select(prop => (
                prop,
                new Dictionary<string, object?>
                {
                    { "Model", prop },
                    { "ValueChanged", EventCallback.Factory.Create<object>(this, (val) => {})}
                }
            )).ToList();
        }
    }
}
